package bloom4cj.standard.test
import std.unittest.*
import std.unittest.testmacro.*
import bloom4cj.standard.*
import std.core.Exception

@Test
public class Bloom4cjTest{
    
    // æµ‹è¯•ç”¨çš„ç¬¬ä¸€ä¸ªå•è¯è¡¨
    var web1: Array<Array<Byte>> = [
        StandardBloom.valToBinaryFromPudge<String>("æˆ‘çˆ±å›½å®¶"),
        StandardBloom.valToBinaryFromPudge<Int64>(1234567890),
        StandardBloom.valToBinaryFromPudge<Int32>(123456),
        StandardBloom.valToBinaryFromPudge<Int16>(1234),
        StandardBloom.valToBinaryFromPudge<Float64>(3.1415926535),
        StandardBloom.valToBinaryFromPudge<Float32>(2.0001234),
        StandardBloom.valToBinaryFromPudge<Float16>(1.618),
        StandardBloom.valToBinaryFromPudge<String>("ä½ å¥½ï¼Œä¸–ç•Œï¼"),
        StandardBloom.valToBinaryFromPudge<String>("Special@Character#123"),
        StandardBloom.valToBinaryFromPudge<Int64>(-9876543210),
        StandardBloom.valToBinaryFromPudge<String>("12345æµ‹è¯•"),
        StandardBloom.valToBinaryFromPudge<Int32>(-67890),
        StandardBloom.valToBinaryFromPudge<Float32>(0.1234),
        StandardBloom.valToBinaryFromPudge<String>("ğŸŒŸğŸŒğŸš€"),
        "åŠŸæˆåå°±".toArray(),
        "æ— æ‡ˆå¯å‡»".toArray(),
        "æ‰é«˜å…«æ–—".toArray(),
        "ä¸€é©¬å½“å…ˆ".toArray(),
        "äº‹åŠåŠŸå€".toArray(),
        "å¿ƒæœ‰ä½™è€ŒåŠ›ä¸è¶³".toArray()
    ]

    // æµ‹è¯•ç”¨çš„ç¬¬äºŒä¸ªå•è¯è¡¨
    var web2: Array<Array<Byte>> = [
        StandardBloom.valToBinaryFromPudge<String>("æ¬¢è¿æ¥åˆ°ç¼–ç¨‹ä¸–ç•Œ"),
        StandardBloom.valToBinaryFromPudge<Int64>(987654321098765432),
        StandardBloom.valToBinaryFromPudge<Int32>(2147483647),
        StandardBloom.valToBinaryFromPudge<Int16>(32000),
        StandardBloom.valToBinaryFromPudge<Float64>(9.876543210987654),
        StandardBloom.valToBinaryFromPudge<Float32>(0.0001234),
        StandardBloom.valToBinaryFromPudge<Float16>(42.42),
        StandardBloom.valToBinaryFromPudge<String>("ç¼–ç¨‹çœŸæœ‰è¶£ï¼"),
        StandardBloom.valToBinaryFromPudge<String>("ç‰¹æ®Šå­—ç¬¦ï¼š~!@#%^&*()_+{}|:\"<>?"),
        StandardBloom.valToBinaryFromPudge<Int64>(-123456789012345678),
        StandardBloom.valToBinaryFromPudge<String>("Data#1234ğŸ”¢"),
        StandardBloom.valToBinaryFromPudge<Int32>(-2147483648),
        StandardBloom.valToBinaryFromPudge<Float32>(3.14159),
        StandardBloom.valToBinaryFromPudge<String>("ğŸ’¡ğŸ’»ğŸ”§æŠ€æœ¯"),
        "å¦‚é›·è´¯è€³".toArray(),
        "é’å‡ºäºè“".toArray(),
        "èº«å¿ƒä¿±ç–²".toArray(),
        "ç™¾æŠ˜ä¸æŒ ".toArray(),
        "å¿è¾±è´Ÿé‡".toArray(),
        "ä¸æ±‚ç”šè§£".toArray()
    ]
    
    // æµ‹è¯•Bloomè¿‡æ»¤å™¨çš„å‡†ç¡®æ€§
    @TestCase
    public func testBloomFilter(){
        // å‡é˜´æ€§è®¡æ•°å™¨
        var fn = 0
        // å‡é˜³æ€§è®¡æ•°å™¨
        var fp = 0

        // åˆå§‹åŒ–Bloomè¿‡æ»¤å™¨ï¼Œé¢„è®¡æ·»åŠ 100ä¸ªå…ƒç´ ï¼Œè¯¯æŠ¥ç‡0.01
        var bloom : StandardBloom = StandardBloom(100)

        // å°†web1ä¸­çš„æ¯ä¸ªå•è¯æ·»åŠ åˆ°Bloomè¿‡æ»¤å™¨ä¸­
        for (word in web1) {
            bloom.Add(word)
        }

        // æ£€æŸ¥web1ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web1) {
            if (!bloom.Check(word)) { 
                fn++
            }
        }

        // æ£€æŸ¥web2ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦é”™è¯¯åœ°å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web2) {
            if (bloom.Check(word)) { 
                fp++
            }
        }

        // æ–­è¨€å‡é˜´æ€§ä¸º0
        @Expect(fn, 0)  
        // æ–­è¨€å‡é˜³æ€§ä¸è¶…è¿‡1
        @Expect(fp <= 1, true)  
    }

    // ä½¿ç”¨CRC64 Hashçš„Benchmarkæµ‹è¯•
    @TestCase
    public func BenchmarkBloomCRC64(){
        // å‡é˜´æ€§è®¡æ•°å™¨
        var fn = 0
        // å‡é˜³æ€§è®¡æ•°å™¨
        var fp = 0

        // åˆå§‹åŒ–Bloomè¿‡æ»¤å™¨ï¼Œm=100ï¼Œä½¿ç”¨CRC64 Hash
        var bloom : StandardBloom = StandardBloom(100)
        bloom.SetHasher(CRC64Hash)

        // å°†web1ä¸­çš„æ¯ä¸ªå•è¯æ·»åŠ åˆ°Bloomè¿‡æ»¤å™¨ä¸­
        for (word in web1) {
            bloom.Add(word)
        }

        // æ£€æŸ¥web1ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web1) {
            if (!bloom.Check(word)) { 
                fn++
            }
        }

        // æ£€æŸ¥web2ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦é”™è¯¯åœ°å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web2) {
            if (bloom.Check(word)) { 
                fp++
            }
        }

        // æ–­è¨€å‡é˜´æ€§ä¸º0
        @Expect(fn, 0)  
        // æ–­è¨€å‡é˜³æ€§ä¸è¶…è¿‡1
        @Expect(fp <= 1, true)  
    }

    // CRC64 Hashå‡½æ•°
    func CRC64Hash(data: Array<Byte>) : UInt64 {
        // CRC64å¤šé¡¹å¼
        const poly: UInt64 = 0xC96C5795D7870F42
        // åˆå§‹åŒ–CRCå€¼
        var crc: UInt64 = 0xFFFFFFFFFFFFFFFF  

        // é€å­—èŠ‚è®¡ç®—CRC
        for (b in data) {
            crc ^= UInt64(b)  
            // å¤„ç†æ¯ä¸ªå­—èŠ‚çš„8ä½
            for (i in 0..7) {
                if ((crc & 1) != 0) {
                    crc = (crc >> 1) ^ poly  
                } else {
                    crc = crc >> 1  
                }
            }
        }
        // è¿”å›æ— ç¬¦å·çš„CRCå€¼
        return crc
    }
}