package bloom4cj.standard.test
import std.unittest.*
import std.unittest.testmacro.*
import bloom4cj.standard.*
import std.core.Exception
import pudge4cj.*

@Test
public class Bloom4cjTest{
    
    // é‡‡ç”¨pudge4cjä¸­è‡ªå®šä¹‰çš„æ–¹æ³•å¯¼å…¥çš„å¤šç§ç±»å‹çš„æ•°æ®
    var web1: Array<Array<Byte>> = [
        StandardBloom.valToBinaryFromPudge<String>("æˆ‘çˆ±å›½å®¶"),
        StandardBloom.valToBinaryFromPudge<Int64>(1234567890),
        StandardBloom.valToBinaryFromPudge<Int32>(123456),
        StandardBloom.valToBinaryFromPudge<Int16>(1234),
        StandardBloom.valToBinaryFromPudge<Float64>(3.1415926535),
        StandardBloom.valToBinaryFromPudge<Float32>(2.0001234),
        StandardBloom.valToBinaryFromPudge<Float16>(1.618),
        StandardBloom.valToBinaryFromPudge<String>("ä½ å¥½ï¼Œä¸–ç•Œï¼"),
        StandardBloom.valToBinaryFromPudge<String>("Special@Character#123"),
        StandardBloom.valToBinaryFromPudge<Int64>(-9876543210),
        StandardBloom.valToBinaryFromPudge<String>("12345æµ‹è¯•"),
        StandardBloom.valToBinaryFromPudge<Int32>(-67890),
        StandardBloom.valToBinaryFromPudge<Float32>(0.1234),
        StandardBloom.valToBinaryFromPudge<String>("ğŸŒŸğŸŒğŸš€"),
        StandardBloom.valToBinaryFromPudge<String>("Pythonç¼–ç¨‹"),
        StandardBloom.valToBinaryFromPudge<Float64>(6.02214076),
        StandardBloom.valToBinaryFromPudge<Int16>(4321),
        StandardBloom.valToBinaryFromPudge<Int32>(54321),
        StandardBloom.valToBinaryFromPudge<String>("C++å¼€å‘è€…çš„ä¸–ç•Œ"),
        StandardBloom.valToBinaryFromPudge<Float64>(1.414213562)
    ]

    // é‡‡ç”¨pudge4cjä¸­è‡ªå®šä¹‰çš„æ–¹æ³•å¯¼å…¥çš„å¤šç§ç±»å‹çš„æ•°æ®
    var web2: Array<Array<Byte>> = [
        StandardBloom.valToBinaryFromPudge<String>("æ¬¢è¿æ¥åˆ°ç¼–ç¨‹ä¸–ç•Œ"),
        StandardBloom.valToBinaryFromPudge<Int64>(987654321098765432),
        StandardBloom.valToBinaryFromPudge<Int32>(2147483647),
        StandardBloom.valToBinaryFromPudge<Int16>(32000),
        StandardBloom.valToBinaryFromPudge<Float64>(9.876543210987654),
        StandardBloom.valToBinaryFromPudge<Float32>(0.0001234),
        StandardBloom.valToBinaryFromPudge<Float16>(42.42),
        StandardBloom.valToBinaryFromPudge<String>("ç¼–ç¨‹çœŸæœ‰è¶£ï¼"),
        StandardBloom.valToBinaryFromPudge<String>("ç‰¹æ®Šå­—ç¬¦ï¼š~!@#%^&*()_+{}|:\"<>?"),
        StandardBloom.valToBinaryFromPudge<Int64>(-123456789012345678),
        StandardBloom.valToBinaryFromPudge<String>("Data#1234ğŸ”¢"),
        StandardBloom.valToBinaryFromPudge<Int32>(-2147483648),
        StandardBloom.valToBinaryFromPudge<Float32>(3.14159),
        StandardBloom.valToBinaryFromPudge<String>("ğŸ’¡ğŸ’»ğŸ”§æŠ€æœ¯"),
        StandardBloom.valToBinaryFromPudge<String>("Javaå¼€å‘è€…çš„è£è€€"),
        StandardBloom.valToBinaryFromPudge<Float64>(2.718281828),
        StandardBloom.valToBinaryFromPudge<Int16>(5000),
        StandardBloom.valToBinaryFromPudge<Int32>(-99999),
        StandardBloom.valToBinaryFromPudge<String>("æ¬¢è¿ä½¿ç”¨Goè¯­è¨€ï¼"),
        StandardBloom.valToBinaryFromPudge<Float64>(1.6180339887)
    ] 

    // é‡‡ç”¨CangJieè‡ªå¸¦çš„toArrayæ–¹æ³•å¯¼å…¥çš„å¤šç§ç±»å‹çš„æ•°æ®
    var web3: Array<Array<Byte>> = [
        "åˆ›æ–°ç§‘æŠ€".toArray(),
        "æ™ºèƒ½ç®—æ³•".toArray(),
        "æ•°æ®åˆ†æ".toArray(),
        "äº‘è®¡ç®—å¹³å°".toArray(),
        "äººå·¥æ™ºèƒ½".toArray(),
        "åŒºå—é“¾æŠ€æœ¯".toArray(),
        "ç‰©è”ç½‘".toArray(),
        "å¤§æ•°æ®".toArray(),
        "æœºå™¨å­¦ä¹ ".toArray(),
        "æ·±åº¦å­¦ä¹ ".toArray(),
        "è‡ªç„¶è¯­è¨€å¤„ç†".toArray(),
        "è®¡ç®—æœºè§†è§‰".toArray(),
        "è™šæ‹ŸğŸŒŸğŸŒğŸš€ç°å®".toArray(),
        "å¢å¼ºç°å®".toArray(),
        "è‡ªåŠ¨é©¾é©¶".toArray(),
        "é‡å­è®¡ç®—".toArray(),
        "è¾¹ç¼˜è®¡ç®—".toArray(),
        "1".toArray(),
        "e".toArray(),
        "2.1".toArray()
    ]

    // é‡‡ç”¨CangJieè‡ªå¸¦çš„toArrayæ–¹æ³•å¯¼å…¥çš„å¤šå¼ ç±»å‹çš„æ•°æ®
    var web4: Array<Array<Byte>> = [
        "ç”Ÿç‰©ä¿¡æ¯å­¦".toArray(),
        "çº³ç±³æŠ€æœ¯".toArray(),
        "å¯å†ç”Ÿèƒ½æº".toArray(),
        "åŸºå› ç¼–è¾‘".toArray(),
        "æ™ºæ…§åŸå¸‚".toArray(),
        "æ— äººå•†åº—".toArray(),
        "è‡ªåŠ¨åŒ–ç”Ÿäº§".toArray(),
        "æ™ºèƒ½åŒ»ç–—".toArray(),
        "æœºå™¨äººæŠ€æœ¯".toArray(),
        "å¯ç©¿æˆ´è®¾å¤‡".toArray(),
        "æ™ºèƒ½äº¤é€š".toArray(),
        "ğŸŒŸğŸŒ".toArray(),
        "æ™ºèƒ½ç‰©æµ".toArray(),
        "æ™ºèƒ½å†œä¸š".toArray(),
        "è™šæ‹ŸåŠ©æ‰‹".toArray(),
        "æ™ºèƒ½æ•™è‚²".toArray(),
        "æ™ºèƒ½é‡‘è".toArray(),
        "3".toArray(),
        "Ar".toArray(),
        "3.4".toArray()
    ]

    // è‡ªå®šä¹‰æ–¹æ³•å¯¼å…¥æ•°æ®ï¼Œå¹¶æµ‹è¯•Bloomè¿‡æ»¤å™¨çš„å‡†ç¡®æ€§
    @TestCase
    public func testBloomFilterByPudge(){
        // å‡é˜´æ€§è®¡æ•°å™¨
        var fn = 0
        // å‡é˜³æ€§è®¡æ•°å™¨
        var fp = 0

        // åˆå§‹åŒ–Bloomè¿‡æ»¤å™¨ï¼Œé¢„è®¡æ·»åŠ 100ä¸ªå…ƒç´ ï¼Œè¯¯æŠ¥ç‡0.01
        var bloom : StandardBloom = StandardBloom(100)

        // å°†web1ä¸­çš„æ¯ä¸ªå•è¯æ·»åŠ åˆ°Bloomè¿‡æ»¤å™¨ä¸­
        for (word in web1) {
            bloom.add(word)
        }

        // æ£€æŸ¥web1ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web1) {
            if (!bloom.check(word)) { 
                fn++
            }
        }

        // æ£€æŸ¥web2ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦é”™è¯¯åœ°å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web2) {
            if (bloom.check(word)) { 
                fp++
            }
        }

        // æ–­è¨€å‡é˜´æ€§ä¸º0
        @Expect(fn, 0)  
        // æ–­è¨€å‡é˜³æ€§ä¸è¶…è¿‡1
        @Expect(fp <= 1, true)  
    }

    // è‡ªå®šä¹‰æ–¹æ³•å¯¼å…¥æ•°æ®ï¼Œå¹¶è‡ªå®šä¹‰CRC64å“ˆå¸Œå‡½æ•°æµ‹è¯•Bloomè¿‡æ»¤å™¨çš„å‡†ç¡®æ€§
    @TestCase
    public func testBloomFilterCRC64ByPudge(){
        // å‡é˜´æ€§è®¡æ•°å™¨
        var fn = 0
        // å‡é˜³æ€§è®¡æ•°å™¨
        var fp = 0

        // åˆå§‹åŒ–Bloomè¿‡æ»¤å™¨ï¼Œm=100ï¼Œä½¿ç”¨CRC64 Hash
        var bloom : StandardBloom = StandardBloom(100)
        bloom.setHasher(CRC64Hash)

        // å°†web1ä¸­çš„æ¯ä¸ªå•è¯æ·»åŠ åˆ°Bloomè¿‡æ»¤å™¨ä¸­
        for (word in web1) {
            bloom.add(word)
        }

        // æ£€æŸ¥web1ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web1) {
            if (!bloom.check(word)) { 
                fn++
            }
        }

        // æ£€æŸ¥web2ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦é”™è¯¯åœ°å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web2) {
            if (bloom.check(word)) { 
                fp++
            }
        }

        // æ–­è¨€å‡é˜´æ€§ä¸º0
        @Expect(fn, 0)  
        // æ–­è¨€å‡é˜³æ€§ä¸è¶…è¿‡1
        @Expect(fp <= 1, true)  
    }

    // toArrayæ–¹æ³•å¯¼å…¥æ•°æ®ï¼Œå¹¶æµ‹è¯•Bloomè¿‡æ»¤å™¨çš„å‡†ç¡®æ€§
    @TestCase
    public func testBloomFilter(){
        // å‡é˜´æ€§è®¡æ•°å™¨
        var fn = 0
        // å‡é˜³æ€§è®¡æ•°å™¨
        var fp = 0

        // åˆå§‹åŒ–Bloomè¿‡æ»¤å™¨ï¼Œé¢„è®¡æ·»åŠ 100ä¸ªå…ƒç´ ï¼Œè¯¯æŠ¥ç‡0.01
        var bloom : StandardBloom = StandardBloom(100)

        // å°†web1ä¸­çš„æ¯ä¸ªå•è¯æ·»åŠ åˆ°Bloomè¿‡æ»¤å™¨ä¸­
        for (word in web3) {
            bloom.add(word)
        }

        // æ£€æŸ¥web1ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web3) {
            if (!bloom.check(word)) { 
                fn++
            }
        }

        // æ£€æŸ¥web2ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦é”™è¯¯åœ°å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web4) {
            if (bloom.check(word)) { 
                fp++
            }
        }

        // æ–­è¨€å‡é˜´æ€§ä¸º0
        @Expect(fn, 0)  
        // æ–­è¨€å‡é˜³æ€§ä¸è¶…è¿‡1
        @Expect(fp <= 1, true)  
    }

    // toArrayæ–¹æ³•å¯¼å…¥æ•°æ®ï¼Œå¹¶è‡ªå®šä¹‰CRC64å“ˆå¸Œå‡½æ•°æµ‹è¯•Bloomè¿‡æ»¤å™¨çš„å‡†ç¡®æ€§
    @TestCase
    public func testBloomFilterCRC64(){
        // å‡é˜´æ€§è®¡æ•°å™¨
        var fn = 0
        // å‡é˜³æ€§è®¡æ•°å™¨
        var fp = 0

        // åˆå§‹åŒ–Bloomè¿‡æ»¤å™¨ï¼Œm=100ï¼Œä½¿ç”¨CRC64 Hash
        var bloom : StandardBloom = StandardBloom(100)
        bloom.setHasher(CRC64Hash)

        // å°†web1ä¸­çš„æ¯ä¸ªå•è¯æ·»åŠ åˆ°Bloomè¿‡æ»¤å™¨ä¸­
        for (word in web3) {
            bloom.add(word)
        }

        // æ£€æŸ¥web1ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web3) {
            if (!bloom.check(word)) { 
                fn++
            }
        }

        // æ£€æŸ¥web2ä¸­çš„æ¯ä¸ªå•è¯æ˜¯å¦é”™è¯¯åœ°å­˜åœ¨äºBloomè¿‡æ»¤å™¨ä¸­
        for (word in web4) {
            if (bloom.check(word)) { 
                fp++
            }
        }

        // æ–­è¨€å‡é˜´æ€§ä¸º0
        @Expect(fn, 0)  
        // æ–­è¨€å‡é˜³æ€§ä¸è¶…è¿‡1
        @Expect(fp <= 1, true)  
    }

    // CRC64 Hashå‡½æ•°
    func CRC64Hash(data: Array<Byte>) : UInt64 {
        // CRC64å¤šé¡¹å¼
        const poly: UInt64 = 0xC96C5795D7870F42
        // åˆå§‹åŒ–CRCå€¼
        var crc: UInt64 = 0xFFFFFFFFFFFFFFFF  

        // é€å­—èŠ‚è®¡ç®—CRC
        for (b in data) {
            crc ^= UInt64(b)  
            // å¤„ç†æ¯ä¸ªå­—èŠ‚çš„8ä½
            for (_ in 0..7) {
                if ((crc & 1) != 0) {
                    crc = (crc >> 1) ^ poly  
                } else {
                    crc = crc >> 1  
                }
            }
        }
        // è¿”å›æ— ç¬¦å·çš„CRCå€¼
        return crc
    }
}